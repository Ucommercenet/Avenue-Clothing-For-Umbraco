@using UCommerce
@using UCommerce.Api
@using UCommerce.Content
@using UCommerce.Extensions
@using UCommerce.EntitiesV2
@using UCommerce.Infrastructure
@using UCommerce.Runtime
@using UCommerce.Search
@using umbraco.MacroEngines
@helper DisplayListProducts(IEnumerable<UCommerce.EntitiesV2.Product> products, UCommerce.EntitiesV2.Category category)
{
    var facetsForQuerying = Request.QueryString.ToFacets();

    var filterProducts = category != null ? SearchLibrary.GetProductsFor(category, facetsForQuerying) : new List<UCommerce.Documents.Product>();

    if (filterProducts.Any())
    {
        foreach (var product in filterProducts.Where(x => x.DisplayOnSite))
        {
            var listProduct = products.First(x => x.Sku == product.Sku && x.VariantSku == product.VariantSku);
            @DisplayListItemProduct(listProduct, category)
        }       
    }
    else
    {
        foreach (var product in products.Where(x => x.DisplayOnSite))
        {
            @DisplayListItemProduct(product, category);
        }
    }
}
@helper DisplayListItemProduct(UCommerce.EntitiesV2.Product product, UCommerce.EntitiesV2.Category category)
{
var url = CatalogLibrary.GetNiceUrlForProduct(product, category);
var price = CatalogLibrary.CalculatePrice(product);
    <div class="product col-sm-4 col-md-4 col-xs-2">
        <div class="product-image">
            @if (!string.IsNullOrEmpty(product.ThumbnailImageMediaId))
            {
                var media = ObjectFactory.Instance.Resolve<IImageService>().GetImage(product.ThumbnailImageMediaId).Url;
                <a href="@url"><img src="@media"></a>
            }
            @if (product.ProductReviews.Any())
            {
                @* View /App_Code/ReviewHelpers.cshtml for this helper *@
                <p class="ratings">@uCommerce.Helpers.ProductReview.DisplayStars(product.Rating)</p>
            }
           
        </div>
        <p class="item-name"><a href="@url">@product.DisplayName()</a></p>
        <p class="item-price">@(price.YourPrice != null ? price.YourPrice.Amount.ToString() : "")</p>
        <p class="btn-group view-details"><a href="@url" class="btn btn-default">View more <span><i class="fa fa-shopping-cart" aria-hidden="true"></i></span></a></p>
    </div>
}