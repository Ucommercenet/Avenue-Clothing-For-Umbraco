@using UCommerce.Api
@using UCommerce.EntitiesV2
@using UCommerce.Extensions
@using UCommerce.Runtime
@using umbraco.MacroEngines
@{
    Category category = SiteContext.Current.CatalogContext.CurrentCategory;
}
@helper RenderStars(IEnumerable<ProductReview> ratings)
    {
    var productReviews = ratings as List<ProductReview> ?? ratings.ToList();
    if (productReviews.Any())
    {
        var rating = productReviews.Average(r => r.Rating);
    <p class="ratings"><span>
        @for (var i = 1; i <= 5; i++)
        {
            if (rating >= i)
            {
            <i class="icon-star"></i>
            }
            else
            {
            <i class="icon-star-empty"></i>
            }
        }
    </span></p>
    }
}
@helper RenderProducts(Category category)
    {
        var products = CatalogLibrary.GetProducts(category);
        if (products.Any())
        {
            foreach (var product in products)
            {
                var url = CatalogLibrary.GetNiceUrlForProduct(product, category);
                var price = CatalogLibrary.CalculatePrice(product);
    <div class="product span4">
        <div class="product-image">
            @if (!string.IsNullOrEmpty(product.ThumbnailImageMediaId))
            {
                dynamic mediaItem = new DynamicMedia(product.ThumbnailImageMediaId);
                <a href="@url"><img src="@mediaItem.umbracoFile" /></a>
            }
            @RenderStars(product.ProductReviews)
        </div>
        <p class="item-name"><a href="@url">@product.DisplayName()</a></p>
        <p class="item-price">@price.YourPrice.AmountExclTax</p>
        <p class="btn-group view-details"><a href="#" class="btn">View more <span><i class="icon-shopping-cart icon-white"></i></span></a></p>
    </div>    
            }
        }
        foreach (var childCategory in category.Categories)
        {
    @RenderProducts(childCategory)
        }
}
<div class="row-fluid">
    <div class="hero-unit">
        @if (!string.IsNullOrEmpty(category.ImageMediaId))
        {
            dynamic mediaItem = new DynamicMedia(category.ImageMediaId);
            <img src="@mediaItem.umbracoFile" alt="@category.DisplayName()" />
        }
    </div>
</div>
<div class="row-fluid">
    <div class="span12 product-list">
        @RenderProducts(category)
    </div>
</div>
